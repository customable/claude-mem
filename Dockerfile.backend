# Backend Dockerfile
# Serves REST API, WebSocket Hub for workers, and static UI files

FROM node:22-slim AS builder

WORKDIR /app

# Install pnpm
RUN npm install -g pnpm

# Copy package files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY packages/types/package.json packages/types/
COPY packages/shared/package.json packages/shared/
COPY packages/database/package.json packages/database/
COPY packages/backend/package.json packages/backend/
COPY packages/ui/package.json packages/ui/

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source files
COPY tsconfig.base.json ./
COPY packages/types packages/types
COPY packages/shared packages/shared
COPY packages/database packages/database
COPY packages/backend packages/backend
COPY packages/ui packages/ui

# Build all packages
RUN pnpm --filter @claude-mem/types build
RUN pnpm --filter @claude-mem/shared build
RUN pnpm --filter @claude-mem/database build
RUN pnpm --filter @claude-mem/backend build
RUN pnpm --filter @claude-mem/ui build

# Production image
FROM node:22-slim

# Watchtower auto-update labels (Issue #214)
ARG WATCHTOWER_ENABLE=false
LABEL com.centurylinklabs.watchtower.enable="${WATCHTOWER_ENABLE}"
LABEL com.centurylinklabs.watchtower.scope="claude-mem"

WORKDIR /app

# Copy built packages
COPY --from=builder /app/packages/types/dist packages/types/dist
COPY --from=builder /app/packages/types/package.json packages/types/
COPY --from=builder /app/packages/shared/dist packages/shared/dist
COPY --from=builder /app/packages/shared/package.json packages/shared/
COPY --from=builder /app/packages/database/dist packages/database/dist
COPY --from=builder /app/packages/database/package.json packages/database/
COPY --from=builder /app/packages/backend/dist packages/backend/dist
COPY --from=builder /app/packages/backend/package.json packages/backend/

# Copy UI dist (served by backend)
COPY --from=builder /app/packages/ui/dist packages/ui/dist

# Copy root package files for workspace resolution
COPY --from=builder /app/package.json /app/pnpm-workspace.yaml ./
COPY --from=builder /app/node_modules node_modules
COPY --from=builder /app/packages/types/node_modules packages/types/node_modules
COPY --from=builder /app/packages/shared/node_modules packages/shared/node_modules
COPY --from=builder /app/packages/database/node_modules packages/database/node_modules
COPY --from=builder /app/packages/backend/node_modules packages/backend/node_modules

# Create data directory
RUN mkdir -p /data

# Environment defaults
ENV CLAUDE_MEM_DATA_DIR=/data
ENV CLAUDE_MEM_DATABASE_PATH=/data/claude-mem.db
ENV CLAUDE_MEM_BACKEND_PORT=37777
ENV CLAUDE_MEM_BACKEND_BIND=0.0.0.0

# Expose ports
EXPOSE 37777

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
  CMD node -e "fetch('http://localhost:37777/api/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"

# Run backend
CMD ["node", "packages/backend/dist/backend-service.js", "start"]
