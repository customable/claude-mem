# Claude-Mem Development Instructions

## Workflow

**IMMER Ã„nderungen committen und pushen** nach Abschluss einer Aufgabe!

## Wichtige Befehle

### Dev Server Restart
**IMMER** `pnpm run dev:restart` verwenden um Backend und UI neu zu starten:
```bash
pnpm run dev:restart
```

### TypeScript Check
```bash
# Alle Packages auf Root-Ebene
pnpm run typecheck
```

### Build
```bash
pnpm run build
```

### Plugin Build
```bash
pnpm run build:plugin
```

### Plugin Sync (nach Build!)
```bash
pnpm run sync-marketplace
```
Synchronisiert das Plugin in alle Claude-Installationen. **Claude Code muss danach neu gestartet werden!**

## Projekt-Struktur

- `packages/types` - Shared TypeScript types
- `packages/shared` - Shared utilities, constants, logger
- `packages/database` - SQLite database layer
- `packages/backend` - Express API server
- `packages/hooks` - Claude Code hooks handlers
- `packages/worker` - Background worker for AI tasks
- `packages/ui` - React/Vite frontend

## Datenbank

SQLite-Datenbank unter `~/.claude-mem/claude-mem.db`

### Wichtige Tabellen

| Tabelle | Beschreibung |
|---------|--------------|
| `sdk_sessions` | Claude Code Sessions mit working_directory |
| `observations` | AI-generierte Observations mit cwd |
| `session_summaries` | Session-Zusammenfassungen |
| `project_claudemd` | Generierter CLAUDE.md Content |
| `task_queue` | Worker Task Queue |
| `documents` | Gecachte MCP-Dokumentation (Context7, WebFetch) |

### Abfrage-Beispiele

```bash
# Sessions abfragen (WICHTIG: Tabelle heiÃŸt sdk_sessions!)
sqlite3 ~/.claude-mem/claude-mem.db "SELECT id, content_session_id, working_directory, status FROM sdk_sessions ORDER BY id DESC LIMIT 5"

# Observations abfragen
sqlite3 ~/.claude-mem/claude-mem.db "SELECT id, title, type, cwd FROM observations ORDER BY id DESC LIMIT 5"

# CLAUDE.md Content abfragen
sqlite3 ~/.claude-mem/claude-mem.db "SELECT id, project, content_session_id, working_directory FROM project_claudemd ORDER BY id DESC LIMIT 5"

# Task Queue Status
sqlite3 ~/.claude-mem/claude-mem.db "SELECT type, status, COUNT(*) as count FROM task_queue GROUP BY type, status"
```

## CLAUDE.md Auto-Generation

Das Plugin generiert automatisch Context-Sections in CLAUDE.md-Dateien.

**Komponenten:**
- `SSE-Writer` - Wird beim Session-Start gespawnt, lauscht auf SSE-Events
- `claude-md` Task - Generiert den Content (AI-basiert)
- `project_claudemd` Tabelle - Speichert generierten Content

**Timing:**
- Nach jeder X. Observation wird ein `claude-md` Task gequeued (Standard: 10)
- Nach Session-Ende wird ebenfalls generiert (via summarize-Task)
- SSE-Writer empfÃ¤ngt `claudemd:ready` Event und schreibt die Datei
- Subdirectories mit Observations bekommen automatisch eigene CLAUDE.md Dateien

**Konfiguration:**
- `CLAUDEMD_ENABLED: true` in `~/.claude-mem/settings.json`
- `CLAUDEMD_OBSERVATION_INTERVAL: 10` - Anzahl Observations bis zur nÃ¤chsten Generierung

**Debugging:**
```bash
# SSE-Writer Prozesse prÃ¼fen
ps aux | grep sse-writer

# PID-Dateien prÃ¼fen
ls ~/.claude-mem/sse-writer-*.pid

# Generierten Content in DB prÃ¼fen
sqlite3 ~/.claude-mem/claude-mem.db "SELECT id, project, content_session_id FROM project_claudemd ORDER BY id DESC"
```

## Neue Migration erstellen

1. **Migration-Datei erstellen:**
   ```bash
   # In packages/database/src/mikro-orm/migrations/
   Migration20260123000005_CreateDocumentsTable.ts
   ```

2. **Migration in Index exportieren:**
   ```typescript
   // packages/database/src/mikro-orm/migrations/index.ts
   export { Migration20260123000005_CreateDocumentsTable } from './Migration20260123000005_CreateDocumentsTable.js';

   export const mikroOrmMigrations = [
     // ... bestehende Migrations
     'Migration20260123000005_CreateDocumentsTable',
   ];
   ```

3. **Migration in Config registrieren:**
   ```typescript
   // packages/database/src/mikro-orm.config.ts
   import { Migration20260123000005_CreateDocumentsTable } from './mikro-orm/migrations/Migration20260123000005_CreateDocumentsTable.js';

   export const migrationsList = [
     // ... bestehende Migrations
     Migration20260123000005_CreateDocumentsTable,
   ];
   ```

4. **Dev-Server neustarten:**
   ```bash
   pnpm run dev:restart
   ```
   Die Migration wird automatisch beim Start ausgefÃ¼hrt.

## Forgejo Issues

Repository: `customable/claude-mem` auf git.customable.host

```bash
# Remote URL
ssh://git@git.customable.host/customable/claude-mem.git
```

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Jan 24, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #12825 | 12:04 PM | ðŸ”µ | SQLite dependency identified in build config | ~936 |
| #12824 | 12:04 PM | ðŸ”µ | No files import bun:sqlite in packages dir | ~735 |
| #12823 | 12:03 PM | ðŸŸ£ | Removed @types/bun devDependency from backend | ~1433 |
| #12822 | 12:03 PM | ðŸŸ£ | Switch from Bun to Node.js for backend scripts | ~1610 |
| #12821 | 12:03 PM | ðŸ”µ | Backend package.json analysis | ~1215 |
| #12820 | 12:03 PM | ðŸŸ£ | Removed test script from database package.json | ~1652 |
| #12819 | 12:03 PM | ðŸŸ£ | Removed Bun-related dependencies from database | ~2015 |
| #12818 | 12:03 PM | ðŸ”µ | Bun dependencies found in backend/database | ~749 |
| #12817 | 12:03 PM | ðŸ”µ | No test files found in database package | ~681 |
| #12816 | 12:03 PM | ðŸ”µ | Database uses MikroORM with multiple SQL drivers | ~1353 |
| #12815 | 12:03 PM | ðŸŸ£ | Simplified database query examples in docs | ~5344 |
| #12814 | 12:03 PM | ðŸŸ£ | Simplified database query command in docs | ~3586 |
| #12813 | 12:02 PM | ðŸ”µ | Database structure and CLAUDE.md auto-gen | ~1881 |
| #12812 | 12:02 PM | ðŸŸ£ | Removed Bun setup from release workflow | ~4904 |
| #12811 | 12:02 PM | ðŸŸ£ | Removed Bun setup from CI workflow | ~1959 |
| #12810 | 12:02 PM | ðŸ”µ | Build script for plugin distribution discovered | ~1301 |
| #12809 | 12:02 PM | ðŸ”µ | Examining release workflow configuration | ~5073 |
| #12808 | 12:02 PM | ðŸ”µ | CI/CD Pipeline Configuration Review | ~1596 |
| #12807 | 12:02 PM | ðŸ”µ | Discovered Forgejo CI/CD workflow files | ~777 |
| #12806 | 12:02 PM | ðŸ”µ | Project uses multiple package managers | ~5378 |
| #12805 | 12:01 PM | ðŸ”„ | Remove Bun dependency, switch to npm | ~6315 |
| #12804 | 12:01 PM | âœ… | Remove Bun from smart-install.js, switch to pnpm | ~1127 |
| #12803 | 12:01 PM | ðŸ”µ | SQLite database dependencies found | ~788 |
| #12802 | 12:01 PM | ðŸ”µ | Database uses Mikro-ORM with multiple SQL drivers | ~1123 |
| #12801 | 12:01 PM | ðŸ”µ | Package.json scripts structure discovered | ~860 |
| #12800 | 12:01 PM | ðŸ”µ | SQLite usage via Bun's built-in module | ~1222 |
| #12799 | 12:00 PM | ðŸ”„ | Remove obsolete uv/Python/Chroma from smart-install | ~1513 |
| #12798 | 12:00 PM | ðŸŸ£ | Pushed refactor branch to remote | ~913 |
| #12797 | 12:00 PM | ðŸ”„ | Remove obsolete uv/Python/Chroma from smart-install | ~1143 |
| #12796 | 12:00 PM | ðŸŸ£ | Staging files for commit | ~684 |

## Key Insights

- **Major Runtime Shift**: Project is transitioning away from Bun runtime to Node.js/npm/pnpm across backend, database, and CI/CD workflows. This affects build scripts, dependencies, and documentation.
- **Database Architecture**: Uses MikroORM with multi-database support (SQLite, MySQL, PostgreSQL) but SQLite is primary via better-sqlite3. Bun's built-in SQLite was only for debugging.
- **CI/CD Changes**: Forgejo workflows modified to remove Bun setup, simplifying the pipeline while maintaining pnpm-based builds.
- **Code Cleanup**: Significant refactoring to remove obsolete dependencies (uv/Python/Chroma) and unused code, improving maintainability.
- **Documentation Updates**: Database query examples simplified to use direct sqlite3 commands instead of Bun scripts, reducing debugging complexity.
</claude-mem-context>
