# Claude-Mem Development Instructions

## Workflow

**IMMER Ã„nderungen committen und pushen** nach Abschluss einer Aufgabe!

## Wichtige Befehle

### Dev Server Restart
**IMMER** `pnpm run dev:restart` verwenden um Backend und UI neu zu starten:
```bash
pnpm run dev:restart
```

### TypeScript Check
```bash
# Alle Packages auf Root-Ebene
pnpm run typecheck
```

### Build
```bash
pnpm run build
```

### Plugin Build
```bash
pnpm run build:plugin
```

### Plugin Sync (nach Build!)
```bash
pnpm run sync-marketplace
```
Synchronisiert das Plugin in alle Claude-Installationen. **Claude Code muss danach neu gestartet werden!**

## Projekt-Struktur

- `packages/types` - Shared TypeScript types
- `packages/shared` - Shared utilities, constants, logger
- `packages/database` - SQLite database layer
- `packages/backend` - Express API server
- `packages/hooks` - Claude Code hooks handlers
- `packages/worker` - Background worker for AI tasks
- `packages/ui` - React/Vite frontend

## Datenbank

SQLite-Datenbank unter `~/.claude-mem/claude-mem.db`

### Wichtige Tabellen

| Tabelle | Beschreibung |
|---------|--------------|
| `sdk_sessions` | Claude Code Sessions mit working_directory |
| `observations` | AI-generierte Observations mit cwd |
| `session_summaries` | Session-Zusammenfassungen |
| `project_claudemd` | Generierter CLAUDE.md Content |
| `task_queue` | Worker Task Queue |

### Abfrage-Beispiele

**Hinweis:** MikroORM wird intern im Backend verwendet. FÃ¼r schnelle Debugging-Abfragen ist `bun:sqlite` einfacher (kein Connection-Setup).

```bash
# Sessions abfragen (WICHTIG: Tabelle heiÃŸt sdk_sessions!)
bun -e "
import Database from 'bun:sqlite';
const db = new Database('/home/jonas/.claude-mem/claude-mem.db', { readonly: true });
console.log(db.query('SELECT id, content_session_id, working_directory, status FROM sdk_sessions ORDER BY id DESC LIMIT 5').all());
"

# Observations abfragen
bun -e "
import Database from 'bun:sqlite';
const db = new Database('/home/jonas/.claude-mem/claude-mem.db', { readonly: true });
console.log(db.query('SELECT id, title, type, cwd FROM observations ORDER BY id DESC LIMIT 5').all());
"

# CLAUDE.md Content abfragen
bun -e "
import Database from 'bun:sqlite';
const db = new Database('/home/jonas/.claude-mem/claude-mem.db', { readonly: true });
console.log(db.query('SELECT id, project, content_session_id, working_directory FROM project_claudemd ORDER BY id DESC LIMIT 5').all());
"

# Task Queue Status
bun -e "
import Database from 'bun:sqlite';
const db = new Database('/home/jonas/.claude-mem/claude-mem.db', { readonly: true });
console.log(db.query('SELECT type, status, COUNT(*) as count FROM task_queue GROUP BY type, status').all());
"
```

## CLAUDE.md Auto-Generation

Das Plugin generiert automatisch Context-Sections in CLAUDE.md-Dateien.

**Komponenten:**
- `SSE-Writer` - Wird beim Session-Start gespawnt, lauscht auf SSE-Events
- `claude-md` Task - Generiert den Content (AI-basiert)
- `project_claudemd` Tabelle - Speichert generierten Content

**Timing:**
- Bei Prompt 1, 6, 11, 16... (alle 5 Prompts) wird ein `claude-md` Task gequeued
- Nach Session-Ende wird ebenfalls generiert
- SSE-Writer empfÃ¤ngt `claudemd:ready` Event und schreibt die Datei

**Konfiguration:**
- `CLAUDEMD_ENABLED: true` in `~/.claude-mem/settings.json`
- Interval ist hardcoded auf 5 Prompts (`CLAUDEMD_INTERVAL` in session-service.ts)

**Debugging:**
```bash
# SSE-Writer Prozesse prÃ¼fen
ps aux | grep sse-writer

# PID-Dateien prÃ¼fen
ls ~/.claude-mem/sse-writer-*.pid

# Generierten Content in DB prÃ¼fen
bun -e "
import Database from 'bun:sqlite';
const db = new Database('/home/jonas/.claude-mem/claude-mem.db', { readonly: true });
console.log(db.query('SELECT id, project, content_session_id FROM project_claudemd ORDER BY id DESC').all());
"
```

## Forgejo Issues

Repository: `thedotmack/claude-mem` auf der lokalen Forgejo-Instanz

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Jan 23

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #11823 | 10:27 PM | ðŸ”µ | Database inspection reveals project_claudemd entries | ~1930 |
| #11822 | 10:27 PM | ðŸ”µ | Discovered hooks package documentation | ~756 |
| #11821 | 10:27 PM | ðŸ”µ | SSE-Writer logs show directory mismatch errors | ~1147 |
| #11820 | 10:27 PM | ðŸ”µ | Task dispatcher handles summarize task storage | ~1257 |
| #11819 | 10:27 PM | ðŸ”µ | Examining Session Entity Structure | ~1088 |
| #11818 | 10:27 PM | ðŸŸ£ | Enhanced database documentation in CLAUDE.md | ~5066 |
| #11817 | 10:27 PM | ðŸ”µ | Located Session-related TypeScript files | ~768 |
| #11816 | 10:27 PM | ðŸ”µ | Session handling in task-dispatcher.ts | ~871 |
| #11815 | 10:26 PM | ðŸŸ£ | Added MikroORM and bun:sqlite debugging note | ~3866 |
| #11814 | 10:26 PM | ðŸ”µ | Database layer uses MikroORM with Repository | ~1003 |
| #11813 | 10:26 PM | ðŸ”µ | Reviewed CLAUDE.md development documentation | ~3212 |
| #11812 | 10:26 PM | ðŸ”µ | CLAUDE.md generation queued after summary | ~1159 |
| #11811 | 10:26 PM | ðŸ”µ | Task Service Creates Claude-MD Tasks | ~1495 |
| #11810 | 10:26 PM | ðŸ”µ | Claude-md task handling in task dispatcher | ~1303 |
| #11809 | 10:26 PM | ðŸ”µ | Database schema reveals full-text search tables | ~1393 |
| #11808 | 10:25 PM | ðŸ”µ | Inspected project_claudemd table schema | ~1847 |
| #11807 | 10:25 PM | ðŸŸ  | Created documentation file for hooks package | ~736 |
| #11806 | 10:25 PM | ðŸ”µ | Verified working_directory values | ~1241 |
| #11805 | 10:25 PM | ðŸ”µ | Inspected sdk_sessions table schema | ~1643 |
| #11804 | 10:25 PM | ðŸ”µ | SSE-Writer logs reveal directory mismatch | ~1464 |
| #11803 | 10:25 PM | ðŸ”µ | Hook system types and structure discovered | ~1519 |
| #11802 | 10:24 PM | ðŸ”µ | Found getSubdirectoriesWithClaudeMd method | ~2814 |
| #11801 | 10:24 PM | ðŸ”µ | CLAUDE.md generation task queueing logic | ~1421 |
| #11800 | 10:24 PM | ðŸ”µ | Discovery of 'claudemd:ready' event usage | ~1246 |
| #11799 | 10:24 PM | ðŸ”µ | Task completion logic in WebSocket dispatcher | ~1184 |
| #11798 | 10:24 PM | ðŸ”µ | Claude-md task type usage in backend | ~1193 |
| #11797 | 10:24 PM | ðŸ”µ | No matches for workingDirectory pattern | ~753 |
| #11796 | 10:24 PM | ðŸ”µ | SSE-Writer log reveals session end events | ~1298 |
| #11795 | 10:24 PM | ðŸ”µ | Found usage of broadcastClaudeMdReady | ~866 |
| #11794 | 10:24 PM | ðŸ”µ | SSE Broadcaster Service Implementation | ~985 |

## Key Insights

- **SSE-Writer Issues**: Repeated "Directory mismatch" errors and session end events indicate potential problems with directory handling and session management in the SSE-Writer component.
- **Database Structure**: The project uses MikroORM with a Repository pattern, and key tables include `project_claudemd`, `sdk_sessions`, and `session_summaries`.
- **Task Management**: CLAUDE.md generation is queued after summary creation, with tasks prioritized and handled by the task dispatcher.
- **Documentation Updates**: Enhanced CLAUDE.md with database tables, queries, and debugging notes, and created documentation for the hooks package.
- **Event-Driven Architecture**: The system uses events like `claudemd:ready` for communication between components, particularly in the SSE broadcaster and task dispatcher.
</claude-mem-context>
